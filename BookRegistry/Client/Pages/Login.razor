@page "/login"
@using BookRegistry.Shared
@using BookRegistry.Client.Auth
@using System.Net.Http.Json
@inject HttpClient HttpClient
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager navManager
@inject Blazored.LocalStorage.ILocalStorageService localStorage

<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card glass-card mt-5">
            <div class="card-header bg-transparent text-center border-0 pt-4">
                <h3 class="text-white">Login</h3>
            </div>
            <div class="card-body">
                @if (ShowAuthError)
                {
                    <div class="alert alert-danger" role="alert">
                        <p>@Error</p>
                    </div>
                }

                <EditForm Model="userLogin" OnValidSubmit="ExecuteLogin">
                    <DataAnnotationsValidator />
                    <div class="mb-3">
                        <label for="email" class="form-label text-light">Email</label>
                        <InputText id="email" class="form-control" @bind-Value="userLogin.Email" />
                        <ValidationMessage For="@(() => userLogin.Email)" />
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label text-light">Password</label>
                        <InputText id="password" type="password" class="form-control" @bind-Value="userLogin.Password" />
                        <ValidationMessage For="@(() => userLogin.Password)" />
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">Login</button>
                    </div>
                    <div class="text-center mt-3">
                        <a href="register" class="text-info text-decoration-none">Don't have an account? Register</a>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
</div>

@code {
    private UserLogin userLogin = new UserLogin();
    private bool ShowAuthError = false;
    private string Error = "";

    private async Task ExecuteLogin()
    {
        ShowAuthError = false;
        var result = await HttpClient.PostAsJsonAsync("api/auth/login", userLogin);
        
        if (!result.IsSuccessStatusCode)
        {
            Error = await result.Content.ReadAsStringAsync();
            ShowAuthError = true;
            return;
        }

        var response = await result.Content.ReadFromJsonAsync<UserSession>();
        await localStorage.SetItemAsync("authToken", response!.Token);
        ((CustomAuthenticationStateProvider)AuthStateProvider).NotifyUserAuthentication(response.Token);
        
        navManager.NavigateTo("/");
    }
}
